(function(h,b){typeof exports=="object"&&typeof module<"u"?b(exports,require("@legendapp/state"),require("sift")):typeof define=="function"&&define.amd?define(["exports","@legendapp/state","sift"],b):(h=typeof globalThis<"u"?globalThis:h||self,b(h.createStore={},h.legendstate,h.sift))})(this,function(h,b,L){"use strict";function P(t){const n=Object.entries(t);return(u,T)=>n.map(([o,s])=>{const a=s===1?u[o]:T[o],g=s===1?T[o]:u[o];return!a||!g?0:typeof a=="string"&&typeof g=="string"?a.localeCompare(g):typeof a=="boolean"&&typeof g=="boolean"?(a?1:0)-(g?1:0):typeof a.getTime=="function"&&typeof g.getTime=="function"?a.getTime()-g.getTime():typeof a=="number"&&typeof g=="number"?a-g:0}).reduce((o,s)=>o||s)}function z(t,n,u){const T=b.observable(n.query||{}),v=b.observable(n.sort||{}),o=b.observable(n.select||[]),s=b.observable(1),a=b.observable(0),g=b.observable(0),S=b.computed(()=>n.style==="paginated"?(n.skip||0)+(s.get()-1)*(n.limit||20):n.skip||0),y=b.computed(()=>{const w=s.get();return(n.limit||20)*w}),x=b.computed(()=>Math.ceil(g.get()/y.get())),j=b.computed(()=>s.get()<x.get());return[b.computed(()=>{const w=t.get();let l=Object.values(w||{}).slice();const C=v.get();if(Object.keys(C).length){const k=P(C);l=l.sort(k)}const E=T.get();if(Object.keys(E).length){const k=L(E);l=l.filter(k)}const B=y.get(),R=S.get();g.set(l.length-(n.skip||0));const M=R,Q=R+B;l=l.slice(M,Q),a.set(l.length);const F=o.get();return F.length&&(l=l.map(k=>Object.keys(k).reduce((e,r)=>(F.includes(r)&&(e[r]=k[r]),e),{}))),l}),{next:()=>{var w;j.peek()&&(s.set(l=>l+1),(w=u==null?void 0:u.onNext)==null||w.call(u,s.get()+1))},prev:()=>{var w;s.peek()!==1&&(s.set(l=>l-1),(w=u==null?void 0:u.onPrev)==null||w.call(u,s.get()+1))}},{page:s,pageSize:y,total:a,canShowMore:j}]}function _(t){var k;let n;const u=((k=t==null?void 0:t.persistentTables)==null?void 0:k.map(([e])=>e))||void 0,T=Object.fromEntries((t==null?void 0:t.persistentTables)||[]),v=b.observable({});function o(e){return!!v[e]}function s(e){o(e)||v.assign({[e]:{}})}function a(e){v[e].delete()}function g(e){return s(e),v[e]}function S(e){return g(e)}function y(e,r){return g(e)[r]}function x(e,r){var f;const c=y(e,r);try{(f=t==null?void 0:t.onGetRow)==null||f.call(t,e,r,c.peek())}catch{}return c}function j(e,r,c){y(e,r).set(c)}function G(e,r){y(e,r).delete()}function w(e,r){return!!g(e)[r]}function l(e,r,c){var i;const d=y(e,r)[c];try{(i=t==null?void 0:t.onGetCell)==null||i.call(t,e,r,c,d.peek())}catch{}return d}function C(e,r,c,f){l(e,r,c).set(f)}function E(e,r,c){y(e,r)[c].delete()}function B(e,r){var m;const c=S(e),[f,d,i]=z(c,r,{onNext:q=>{var O;try{(O=t==null?void 0:t.onQueryRows)==null||O.call(t,e,{...r,skip:(r.skip||0)+(q-1)*i.pageSize.peek()},f.peek())}catch{}}});try{(m=t==null?void 0:t.onQueryRows)==null||m.call(t,e,r,f.peek())}catch{}return[f,d,i]}let R;function M(){R=v.onChange((e,r,c)=>{c.forEach(f=>{const[d,i]=f.path;u!=null&&u.includes(d)&&i&&n&&n.setItem(d,i,y(d,i).peek())})})}function Q(){R==null||R()}async function F(e,r){const c=!!n;if(n=e,(c||!n)&&Q(),c&&!n&&Object.keys(v.peek()).forEach(f=>{a(f)}),n&&u){const f=await n.getAllItems();Object.entries(f).forEach(([d,i])=>{var q;const m=T[d]||"id";i.forEach(O=>{j(d,O[m],O)});try{(q=t==null?void 0:t.onRevalidate)==null||q.call(t,d,i.map(O=>O[m]))}catch{}}),M()}r==null||r()}return{getTable:S,setTable:s,delTable:a,hasTable:o,setRow:j,delRow:G,hasRow:w,getRow:x,queryRows:B,setCell:C,getCell:l,delCell:E,setDatabase:F}}h.createStore=_,h.observableQuery=z,h.siftSort=P,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
