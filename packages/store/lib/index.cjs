"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("@legendapp/state"),G=require("sift");function P(t){const n=Object.entries(t);return(l,R)=>n.map(([y,s])=>{const b=s===1?l[y]:R[y],a=s===1?R[y]:l[y];return!b||!a?0:typeof b=="string"&&typeof a=="string"?b.localeCompare(a):typeof b=="boolean"&&typeof a=="boolean"?(b?1:0)-(a?1:0):typeof b.getTime=="function"&&typeof a.getTime=="function"?b.getTime()-a.getTime():typeof b=="number"&&typeof a=="number"?b-a:0}).reduce((y,s)=>y||s)}function z(t,n,l){const R=o.observable(n.query||{}),h=o.observable(n.sort||{}),y=o.observable(n.select||[]),s=o.observable(1),b=o.observable(0),a=o.observable(0),T=o.computed(()=>n.style==="paginated"?(n.skip||0)+(s.get()-1)*(n.limit||20):n.skip||0),i=o.computed(()=>{const w=s.get();return(n.limit||20)*w}),F=o.computed(()=>Math.ceil(a.get()/i.get())),m=o.computed(()=>s.get()<F.get());return[o.computed(()=>{const w=t.get();let u=Object.values(w||{}).slice();const q=h.get();if(Object.keys(q).length){const v=P(q);u=u.sort(v)}const C=R.get();if(Object.keys(C).length){const v=G(C);u=u.filter(v)}const x=i.get(),O=T.get();a.set(u.length-(n.skip||0));const B=O,M=O+x;u=u.slice(B,M),b.set(u.length);const E=y.get();return E.length&&(u=u.map(v=>Object.keys(v).reduce((e,r)=>(E.includes(r)&&(e[r]=v[r]),e),{}))),u}),{next:()=>{var w;m.peek()&&(s.set(u=>u+1),(w=l==null?void 0:l.onNext)==null||w.call(l,s.get()+1))},prev:()=>{var w;s.peek()!==1&&(s.set(u=>u-1),(w=l==null?void 0:l.onPrev)==null||w.call(l,s.get()+1))}},{page:s,pageSize:i,total:b,canShowMore:m}]}function L(t){var v;let n;const l=((v=t==null?void 0:t.persistentTables)==null?void 0:v.map(([e])=>e))||void 0,R=Object.fromEntries((t==null?void 0:t.persistentTables)||[]),h=o.observable({});function y(e){return!!h[e]}function s(e){y(e)||h.assign({[e]:{}})}function b(e){h[e].delete()}function a(e){return s(e),h[e]}function T(e){return a(e)}function i(e,r){return a(e)[r]}function F(e,r){var f;const c=i(e,r);try{(f=t==null?void 0:t.onGetRow)==null||f.call(t,e,r,c.peek())}catch{}return c}function m(e,r,c){i(e,r).set(c)}function Q(e,r){i(e,r).delete()}function w(e,r){return!!a(e)[r]}function u(e,r,c){var d;const g=i(e,r)[c];try{(d=t==null?void 0:t.onGetCell)==null||d.call(t,e,r,c,g.peek())}catch{}return g}function q(e,r,c,f){u(e,r,c).set(f)}function C(e,r,c){i(e,r)[c].delete()}function x(e,r){var S;const c=T(e),[f,g,d]=z(c,r,{onNext:j=>{var k;try{(k=t==null?void 0:t.onQueryRows)==null||k.call(t,e,{...r,skip:(r.skip||0)+(j-1)*d.pageSize.peek()},f.peek())}catch{}}});try{(S=t==null?void 0:t.onQueryRows)==null||S.call(t,e,r,f.peek())}catch{}return[f,g,d]}let O;function B(){O=h.onChange((e,r,c)=>{c.forEach(f=>{const[g,d]=f.path;l!=null&&l.includes(g)&&d&&n&&n.setItem(g,d,i(g,d).peek())})})}function M(){O==null||O()}async function E(e,r){const c=!!n;if(n=e,(c||!n)&&M(),c&&!n&&Object.keys(h.peek()).forEach(f=>{b(f)}),n&&l){const f=await n.getAllItems();Object.entries(f).forEach(([g,d])=>{var j;const S=R[g]||"id";d.forEach(k=>{m(g,k[S],k)});try{(j=t==null?void 0:t.onRevalidate)==null||j.call(t,g,d.map(k=>k[S]))}catch{}}),B()}r==null||r()}return{getTable:T,setTable:s,delTable:b,hasTable:y,setRow:m,delRow:Q,hasRow:w,getRow:F,queryRows:x,setCell:q,getCell:u,delCell:C,setDatabase:E}}exports.createStore=L;exports.observableQuery=z;exports.siftSort=P;
